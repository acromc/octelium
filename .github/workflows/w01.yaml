name: Cleanup All Untagged Images

on:
  workflow_dispatch:
    inputs:
      days_old:
        description: 'Delete images older than (days)'
        required: true
        default: '90'
        type: string
      dry_run:
        description: 'Dry Run? (Check to list images without deleting)'
        required: true
        default: true
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write # Required to delete packages using GITHUB_TOKEN

    steps:
      - name: Clean Images
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Automatically used by gh cli
          DAYS: ${{ inputs.days_old }}
          DRY_RUN: ${{ inputs.dry_run }}
          OWNER: ${{ github.repository_owner }}
        run: |
          echo "## ðŸ§¹ Cleanup Report for Organization: $OWNER" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Image ID | Created At | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          # Calculate cutoff
          CUTOFF_DATE=$(date -d "$DAYS days ago" +%Y-%m-%d)
          CUTOFF_TS=$(date -d "$CUTOFF_DATE" +%s)
          echo "Targeting images older than: $CUTOFF_DATE"

          # 1. Fetch all container packages in the org that this token can see
          # Note: GITHUB_TOKEN can usually only see packages linked to THIS repository.
          echo "Fetching packages list..."
          PACKAGES=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/$OWNER/packages?package_type=container&per_page=100" \
            --jq '.[].name')

          if [ -z "$PACKAGES" ]; then
            echo "No packages found or accessible."
            exit 0
          fi

          # 2. Iterate over every package found
          for PKG in $PACKAGES; do
            echo "Checking package: $PKG"
            
            # Fetch versions for this package
            versions=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/orgs/$OWNER/packages/container/$PKG/versions?per_page=100")

            # Filter: Untagged AND Older than Cutoff
            echo "$versions" | jq -r --argjson cutoff "$CUTOFF_TS" '.[] | select((.metadata.container.tags | length) == 0) | select((.created_at | fromdateiso8601) < $cutoff) | "\(.id) \(.created_at)"' | \
            while read -r version_id created_at; do
              
              if [ "$DRY_RUN" = "true" ]; then
                echo "DRY RUN: Would delete $PKG : $version_id"
                echo "| $PKG | $version_id | $created_at | ðŸŸ¡ Dry Run |" >> $GITHUB_STEP_SUMMARY
              else
                echo "DELETING: $PKG : $version_id"
                
                # Attempt Delete
                set +e # Don't crash script if delete fails (e.g. permission issue)
                gh api \
                  --method DELETE \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "/orgs/$OWNER/packages/container/$PKG/versions/$version_id"
                
                exit_code=$?
                set -e 

                if [ $exit_code -eq 0 ]; then
                  echo "| $PKG | $version_id | $created_at | âœ… Deleted |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "Error deleting. Token might lack scope for this specific package."
                  echo "| $PKG | $version_id | $created_at | âŒ Forbidden (403) |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done
          done
